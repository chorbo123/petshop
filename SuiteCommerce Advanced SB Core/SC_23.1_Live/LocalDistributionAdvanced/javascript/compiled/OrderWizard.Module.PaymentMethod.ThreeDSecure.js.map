{"version":3,"sources":["OrderWizard.Module.PaymentMethod.ThreeDSecure.ts"],"names":[],"mappings":"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","file":"OrderWizard.Module.PaymentMethod.ThreeDSecure.js","sourcesContent":["/*\n\tÂ© 2020 NetSuite Inc.\n\tUser may not copy, modify, distribute, or re-bundle or otherwise make available this code;\n\tprovided, however, if you are an authorized user with a NetSuite account or log-in, you\n\tmay use this code subject to the terms that govern your access and use.\n*/\n\n/// <amd-module name=\"OrderWizard.Module.PaymentMethod.ThreeDSecure\"/>\n\nimport '../../../Commons/Transaction/JavaScript/Transaction.Model';\nimport * as _ from 'underscore';\nimport * as order_wizard_paymentmethod_threedsecure_module_tpl from 'order_wizard_paymentmethod_threedsecure_module.tpl';\nimport * as jQuery from '../../../Commons/Core/JavaScript/jQuery';\nimport * as Utils from '../../../Commons/Utilities/JavaScript/Utils';\nimport { WizardStepModule } from '../../Wizard/JavaScript/Wizard.StepModule';\nimport { isPaymentAuthenticationRequired } from '../../../Commons/CardHolderAuthentication/JavaScript/CardHolderAuthentication';\n\nimport Backbone = require('../../../Commons/Utilities/JavaScript/backbone.custom');\n\nimport Deferred = JQuery.Deferred;\n\nconst OrderWizardModulePaymentMethodThreeDSecure: any = WizardStepModule.extend({\n    // @property {Function} template\n    template: order_wizard_paymentmethod_threedsecure_module_tpl,\n\n    // @property {String} title\n    title: Utils.translate('Credit Card Authentication'),\n    // @property {Object} addressType\n    steps: {\n        DEVICE_AUTHENTICATION: 'authenticatedevice',\n        SHOPPER_CHALLENGE: 'challengeshopper'\n    },\n\n    threeDSecureCallBackModel: 1,\n\n    // @method initialize\n    // @param {Object} options\n    initialize: function(options) {\n        this.application = options.application;\n        this.deferred = options.deferred;\n        this.confirmation = options.confirmation;\n        this.visible =\n            options.confirmation &&\n            options.confirmation.reasoncode !== 'ERR_WS_REQ_DEVICE_AUTHENTICATION';\n        this.serviceHTML = options.confirmation.authenticationformaction\n            ? this.createIFrame(options.confirmation.authenticationformaction)\n            : this.confirmation.get('paymentauthorization').servicehtml;\n\n        this.receiveMessage = this.receiveMessage.bind(this);\n        this.threedSecureCallBackModel =\n            options.threedSecureCallBackModel || this.threedSecureCallBackModel;\n\n        this.currentStep = this.steps.DEVICE_AUTHENTICATION;\n\n        WizardStepModule.prototype.initialize.apply(this, arguments);\n    },\n\n    // @method render\n    // @return {Backbone.View} result\n    render: function() {\n        return WizardStepModule.prototype.render.apply(this, arguments);\n    },\n    closeModalAction: function() {\n        this.model.fetch().then(() => {\n            if (SC.ENVIRONMENT.SCTouchpoint === 'checkout') {\n                this.model.set('internalid', 'cart');\n            }\n            this.model.unset('3dsecure_error');\n            this.wizard.getCurrentStep().enableNavButtons();\n\n            let confirmation = this.model.get('confirmation');\n            if (!(confirmation instanceof Backbone.Model) && !_.isEmpty(confirmation)) {\n                confirmation = new Backbone.Model(this.model.get('confirmation'));\n            }\n\n            if (isPaymentAuthenticationRequired(confirmation)) {\n                this.deferred.reject();\n            }\n        });\n    },\n    onCloseModal: function() {\n        this.on('modal-close', () => {\n            (<any>window).removeEventListener('message', this.receiveMessage, false);\n            this.closeModalAction();\n        });\n    },\n\n    // @method showInModal\n    // @param {Object} options\n    // @return {jQuery.Deferred}\n    showInModal: function(options) {\n        const { error } = this;\n        if (error) {\n            this.render();\n        }\n\n        const promise = this.application\n            .getLayout()\n            .showInModal(this, _.extend({ keyboard: false, backdrop: 'static' }, options));\n\n        promise.done(() => {\n            this.listenForCallback();\n\n            if (!this.visible) {\n                // Hidden iframe for device authentication\n                this.$containerModal.addClass('invisible').removeClass('fade');\n            } else if (!error) {\n                // Visible iframe for shopper challenge\n                this.$containerModal.removeClass('invisible').addClass('fade');\n            }\n            this.onCloseModal();\n        });\n\n        return promise;\n    },\n\n    threeDSecureRequest: function(data) {\n        jQuery\n            .ajax({\n                url: ` services/CardHolderAuthentication.Service.ss?n=${\n                    SC.ENVIRONMENT.siteSettings.siteid\n                }&type=${this.threeDSecureCallBackModel}`,\n                type: 'POST',\n                data: data\n            })\n            .then(result => {\n                const order_info = {\n                    confirmation: result\n                };\n                this.process3DSecure(order_info);\n            });\n    },\n    isSuccess3DSecure: function(data) {\n        return data.confirmation && data.confirmation.confirmationnumber;\n    },\n\n    // @method process3DSecure. Called from ssp 3D Secure file (threedsecure.ssp)\n    // @param {Json} confirmation Order submit answer.\n    process3DSecure: function(order_info) {\n        const { confirmation } = order_info;\n        if (this.isSuccess3DSecure(order_info)) {\n            this.model.set(order_info);\n            this.success();\n        } else if (confirmation && confirmation.reasoncode === 'ERR_WS_REQ_SHOPPER_CHALLENGE') {\n            this.currentStep = this.steps.SHOPPER_CHALLENGE;\n            this.visible = true;\n            this.serviceHTML = this.createIFrame(confirmation.authenticationformaction);\n            this.showInModal();\n        } else if (\n            confirmation &&\n            confirmation.reasoncode === 'ERR_WS_REQUIRE_CUSTOMER_LOGIN' &&\n            confirmation.body !== '' &&\n            !!this.currentStep\n        ) {\n            // calls to threedsecure.ssp coming from external sites may fail,\n            // it needs to be triggered again from samesite.\n            if (this.currentStep === this.steps.DEVICE_AUTHENTICATION) {\n                this.currentStep = this.steps.SHOPPER_CHALLENGE;\n            } else if (this.currentStep === this.steps.SHOPPER_CHALLENGE) {\n                delete this.currentStep;\n            }\n            let returnedParameters = confirmation.body.replace(\n                /([^&=]+=null&)*(&[^&=]+=null)?/g,\n                ''\n            );\n            returnedParameters = `{\"${returnedParameters\n                .replace(/( |&amp;)/g, '\", \"')\n                .replace(/=/g, '\": \"')\n                .replace(' ', '')}\"}`;\n            this.threeDSecureRequest(returnedParameters);\n        } else {\n            this.fail(confirmation.errorMessage);\n        }\n    },\n\n    // @method listenForCallback. Turns callback widely available. Emptying it after use\n    listenForCallback: function() {\n        (<any>window).process3DSecure = data => {\n            (<any>window).process3DSecure = function() {};\n            this.process3DSecure(data);\n        };\n\n        (<any>window).addEventListener('message', this.receiveMessage, false);\n    },\n\n    // @method receiveMessage. listen for 3d secure 2.0 response. postMessage flow.\n    receiveMessage: function(event) {\n        if (!new RegExp(event.origin).test(this.serviceHTML)) {\n            throw new Error('Invalid Origin');\n        }\n\n        (<any>window).removeEventListener('message', this.receiveMessage, false);\n        this.visible = false;\n        this.threeDSecureRequest(event.data);\n    },\n\n    // @method fail Called if confirmation coming from 3D Secure ssp file fails.\n    // @return {jQuery.Deferred} Rejected promise.\n    fail: function(errorMessage: string): Deferred<string> {\n        this.closeModal();\n        this.model.set('internalid', 'cart');\n        return this.deferred.rejectWith(this, [errorMessage]);\n    },\n\n    // @method success Called if confirmation coming from 3D Secure ssp file succeeded.\n    // @return {jQuery.Deferred} Resolved promise.\n    success: function() {\n        this.closeModal();\n        return this.deferred.resolve();\n    },\n\n    // @method closeModal Closes the modal\n    closeModal: function() {\n        this.$containerModal\n            .removeClass('fade')\n            .modal('hide')\n            .data('bs.modal', null);\n\n        (<any>window).removeEventListener('message', this.receiveMessage, false);\n    },\n\n    createIFrame: function(action: string): string {\n        return `<iframe src='${action}' id='3dform' name='threedsecureframe' width='100%' height=600 border=0 frameborder=0></iframe>`;\n    },\n\n    // @method getContext\n    // @return {OrderWizard.Module.PaymentMethod.ThreeDSecure.Context}\n    getContext: function() {\n        return {\n            threeDSecureError: this.model.get('3dsecure_error'),\n            iframe: this.serviceHTML\n        };\n    }\n});\n\nexport = OrderWizardModulePaymentMethodThreeDSecure;\n"]}