{"version":3,"sources":["GoogleAnalytics4.ts"],"names":[],"mappings":"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","file":"GoogleAnalytics4.js","sourcesContent":["/*\n\tÂ© 2020 NetSuite Inc.\n\tUser may not copy, modify, distribute, or re-bundle or otherwise make available this code;\n\tprovided, however, if you are an authorized user with a NetSuite account or log-in, you\n\tmay use this code subject to the terms that govern your access and use.\n*/\n\n/// <amd-module name=\"GoogleAnalytics4\"/>\n\nimport * as _ from 'underscore';\nimport * as Utils from '../../../Commons/Utilities/JavaScript/Utils';\nimport * as jQuery from '../../../Commons/Core/JavaScript/jQuery';\nimport { Configuration } from '../../SCA/JavaScript/Configuration';\n\nimport Tracker = require('../../../Commons/Tracker/JavaScript/Tracker');\nimport Backbone = require('../../../Commons/Utilities/JavaScript/backbone.custom');\n\nexport = (function(win: any, name) {\n    // @class GoogleAnalytics4 @extends ApplicationModule\n    // ------------------\n    // Loads google analytics 4 script and extends application with methods:\n    // * trackPageview\n    // * trackEvent\n    // * trackTransaction\n    // Also wraps layout's showInModal\n\n    interface GA4Options {\n        send_page_view?: boolean;\n        client_id?: string;\n        session_id?: string;\n    }\n\n    const dataLayerName = name + 'DataLayer';\n\n    const GoogleAnalytics4: any = {\n        // @method doCallback Indicates if this module do a callback after some particular events\n        // @return {Boolean}\n        doCallback: function() {\n            return !!win[name];\n        },\n\n        // @method trackPageview\n        // @param {String} url\n        // @return {GoogleAnalytics4}\n        trackPageview: function(url) {\n            if (_.isString(url)) {\n                url = url.split('?')[0];\n                win.gtag('event', 'page_view', { page_location: url, page_title: url });\n            }\n\n            return this;\n        },\n\n        trackLogin: function(event) {\n            win.gtag('event', 'login', { method: event.category, event_callback: event.callback });\n\n            return this;\n        },\n\n        trackRegister: function(event) {\n            win.gtag('event', 'sign_up', {\n                method: event.category,\n                event_callback: event.callback\n            });\n\n            return this;\n        },\n        trackCheckoutAsGuest: function(event) {\n            win.gtag('event', 'checkout_as_guest', {\n                method: event.category,\n                event_callback: event.callback\n            });\n\n            return this;\n        },\n\n        // @method trackEvent\n        // @param {TrackEvent} event\n        // @return {GoogleAnalytics}\n        trackEvent: function(event) {\n            if (event && event.category && event.action) {\n                win.gtag('event', 'generic_event', {\n                    category: event.category,\n                    action: event.action,\n                    label: event.label,\n                    value: parseFloat(event.value) || 0,\n                    page: event.page || '/' + Backbone.history.fragment,\n                    event_callback: event.callback\n                });\n            }\n\n            return this;\n        },\n\n        // @method trackTransaction\n        // Based on the created SalesOrder we trigger each of the analytics\n        // ecommerce methods passing the required information\n        // [Ecommerce Tracking](https://developers.google.com/analytics/devguides/collection/analyticsjs/ecommerce)\n        // @param {Tracker.Transaction.Model} @extends Backbone.Model transaction\n        // @return {GoogleAnalytics|Void}\n        trackTransaction: function(transaction) {\n            const transaction_id = transaction.get('confirmationNumber');\n\n            const purchase = {\n                transaction_id: transaction_id,\n                value: transaction.get('subTotal'),\n                tax: transaction.get('taxTotal'),\n                shipping: transaction.get('shippingCost') + transaction.get('handlingCost'),\n                currency:\n                    (SC.ENVIRONMENT.currentCurrency && SC.ENVIRONMENT.currentCurrency.code) || '',\n                affiliation: Configuration.get('siteSettings.displayname'),\n                items: []\n            };\n\n            transaction.get('products').each(function(product, index) {\n                purchase.items.push({\n                    item_id: product.get('id'),\n                    item_name: product.get('name'),\n                    affiliation: Configuration.get('siteSettings.displayname'),\n                    currency:\n                        (SC.ENVIRONMENT.currentCurrency && SC.ENVIRONMENT.currentCurrency.code) ||\n                        '',\n                    index: index,\n                    item_category: product.get('category') || '',\n                    item_variant: product.get('options'),\n                    price: product.get('rate'),\n                    quantity: product.get('quantity')\n                });\n            });\n\n            win.gtag('event', 'purchase', purchase);\n\n            return this;\n        },\n\n        // @method addCrossDomainParameters\n        // [Decorating HTML Links](https://developers.google.com/analytics/devguides/collection/analyticsjs/cross-domain#decoratelinks)\n        // @param {string} url\n        // @return {String} url\n        addCrossDomainParameters: function(url) {\n            // We only need to add the parameters if the URL we are trying to go\n            // is not a sub domain of the tracking domain\n            if (_.isString(url)) {\n                url = Utils.addParamsToUrl(url, {\n                    client_id: win[name].client_id,\n                    session_id: win[name].session_id\n                });\n            }\n\n            return url;\n        },\n\n        // @method loadScript\n        // @return {jQuery.Promise|Void}\n        loadScript: function(id: string) {\n            return jQuery.getScript(\n                `//www.googletagmanager.com/gtag/js?id=${id}&l=${dataLayerName}`\n            );\n        },\n\n        // @method mountToApp\n        // @param {ApplicationSkeleton} application\n        // @return {Void}\n        mountToApp: function(application) {\n            const tracking = Configuration.get('tracking.googleAnalyticsFour');\n\n            // if track page view needs to be tracked\n            if (tracking && tracking.propertyID && !SC.isPageGenerator()) {\n                win[dataLayerName] = win[dataLayerName] || [];\n                win.gtag =\n                    win.gtag ||\n                    function() {\n                        win[dataLayerName].push(arguments);\n                    };\n                const domains = [];\n                if (tracking.domainName) {\n                    domains.push(tracking.domainName);\n                }\n                if (tracking.domainNameSecure) {\n                    domains.push(tracking.domainNameSecure);\n                }\n\n                if (domains.length) {\n                    win.gtag('set', 'linker', {\n                        domains: domains\n                    });\n                }\n\n                const configOptions: GA4Options = {\n                    send_page_view: false\n                };\n\n                const client_id = Utils.getParameterByName(win.location.href, 'client_id');\n                const session_id = Utils.getParameterByName(win.location.href, 'session_id');\n\n                if (client_id && session_id) {\n                    configOptions.client_id = client_id;\n                    configOptions.session_id = session_id;\n                }\n\n                win.gtag('js', new Date());\n                win.gtag('config', tracking.propertyID, configOptions);\n\n                // Please keep this statement here or the first pageView on site load\n                // will not be triggered (ApplicationSkeleton.Layout._showContent)\n                Tracker.getInstance().trackers.push(GoogleAnalytics4);\n\n                // the analytics script is only loaded if we are on a browser\n                application.getLayout().once('afterAppendView', function() {\n                    GoogleAnalytics4.loadScript(tracking.propertyID)\n                        .done(function() {\n                            win[name] = {};\n                            win.gtag('get', tracking.propertyID, 'client_id', client_id => {\n                                win[name].client_id = client_id;\n                            });\n                            win.gtag('get', tracking.propertyID, 'session_id', session_id => {\n                                win[name].session_id = session_id;\n                            });\n                        })\n                        .fail(function(jqXhr) {\n                            jqXhr.preventDefault = true;\n                            console.warn('Google Analytics 4 was unable to load');\n                        });\n                });\n            }\n        }\n    };\n\n    return GoogleAnalytics4;\n})(window, 'ga4');\n"]}